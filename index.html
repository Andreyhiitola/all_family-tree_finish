\<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="202601121507">

  <title>–°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ‚ùå –£–î–ê–õ–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –°–¢–†–û–ö–ê: <base href="/all_family-tree_finish/"> -->
  <!-- –≠—Ç–æ –ª–æ–º–∞–ª–æ –ø—É—Ç–∏ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! -->
  
  <link rel="stylesheet" href="style.css?v=202602121250">
  <link rel="stylesheet" href="profile-modal-styles.css?v=202602121250"> 
</head>
<body>
  <header class="app-header">
    <h1>üå≥ –°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ</h1>
    <div class="header-controls">
      <button class="btn" onclick="location.reload()" title="–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ data/people.json">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>
      <button class="btn" onclick="clearCacheAndReload()" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å">üóëÔ∏è –ö—ç—à</button>
      <button id="add-person" style="display: none;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      
      <select id="root-selector" title="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–Ω–µ–≤—É—é —Å–µ–º—å—é">
        <option value="">üå≥ –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–µ–Ω—å...</option>
      </select>
      <button id="export-excel">üì§ Excel-export</button>
      <button id="show-data-table">üìã –¢–∞–±–ª–∏—Ü–∞</button>
      
      
      <button class="btn" onclick="window.exportJsonFile()">üíæ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      
      <input id="search" placeholder="üîç –ü–æ–∏—Å–∫...">
    </div>
  </header>

  <main class="app-main">
    <section class="tree-section">
      <div class="tree-container">
        <svg id="tree-svg" width="1200" height="800"></svg>
      </div>
      <div id="auto-save-status">üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
    </section>

    <aside class="info-panel">
      <div class="info-placeholder">üëÜ –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —á–µ–ª–æ–≤–µ–∫—É</div>
      <div class="person-details" style="display:none">
        <h2>
            <span data-field="name"></span> 
            <span data-field="surname"></span>
        </h2>
        
        <p><strong>–ü–æ–ª:</strong> <span data-field="gender"></span></p>
        <p><strong>–û—Ç—á–µ—Å—Ç–≤–æ:</strong> <span data-field="middlename"></span></p>
        <p><strong>–†–æ–¥–∏–ª—Å—è:</strong> <span data-field="birthDate"></span></p>
        <p><strong>–£–º–µ—Ä:</strong> <span data-field="deathDate"></span></p>
        <p><strong>–ú–µ—Å—Ç–æ:</strong> <span data-field="birthPlace"></span></p>
        <p><strong>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è:</strong> <span data-field="biography"></span></p>

        <div class="person-actions">
          <button id="edit-person">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="delete-person">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>

      <div class="stats">
        <p>üë• –í—Å–µ–≥–æ: <span id="total-people">0</span></p>
      </div>
    </aside>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="person-modal" class="modal">
    <div class="modal-content modal-large">
      <span class="close" id="cancel-form">&times;</span>
      <h2 id="modal-title">–ü–µ—Ä—Å–æ–Ω–∞</h2>
      <form id="person-form">
        <input type="hidden" id="form-id">
        
        <div class="form-row">
          <label>–ò–º—è:</label>
          <input type="text" id="form-name" required>
        </div>
        <div class="form-row">
          <label>–§–∞–º–∏–ª–∏—è:</label>
          <input type="text" id="form-surname" required>
        </div>
        <div class="form-row">
          <label>–û—Ç—á–µ—Å—Ç–≤–æ:</label>
          <input type="text" id="form-middlename">
        </div>
        <div class="form-row">
          <label>–ü–æ–ª:</label>
          <select id="form-gender">
            <option value="M">–ú—É–∂—Å–∫–æ–π</option>
            <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-row">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
          <input type="date" id="form-birthDate">
        </div>
        <div class="form-row">
          <label>–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏:</label>
          <input type="date" id="form-deathDate">
        </div>
        <div class="form-row">
          <label>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
          <input type="text" id="form-birthPlace">
        </div>
        
        <!-- –°–≤—è–∑–∏ -->
        <div class="form-row">
            <label>–û—Ç–µ—Ü:</label>
            <select id="form-father"><option value="">–ù–µ—Ç</option></select>
        </div>
        <div class="form-row">
            <label>–ú–∞—Ç—å:</label>
            <select id="form-mother"><option value="">–ù–µ—Ç</option></select>
        </div>
        <div class="form-row">
            <label>–°—É–ø—Ä—É–≥(–∞):</label>
            <select id="form-spouse"><option value="">–ù–µ—Ç</option></select>
        </div>

        <!-- –§–æ—Ç–æ –∏ –±–∏–æ–≥—Ä–∞—Ñ–∏—è -->
        <div class="form-row">
          <label>–ê–≤–∞—Ç–∞—Ä (–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ URL):</label>
          <input type="text" id="form-photo" placeholder="1.jpg –∏–ª–∏ https://example.com/photo.jpg">
          <small style="color:#666; font-size:11px;">
            –ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –≤ photos/avatars/ –∏ —É–∫–∞–∂–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∏–º—è: 1.jpg<br>
            –ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL: https://example.com/photo.jpg
          </small>
        </div>
        
        <div class="form-row">
          <label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è:</label>
          <textarea id="form-biography" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —á–µ–ª–æ–≤–µ–∫–µ..."></textarea>
        </div>

        <div class="form-row">
          <label>–ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
          <textarea id="form-photos" rows="2" placeholder="1-1.jpg, 1-2.jpg –∏–ª–∏ https://example.com/1.jpg"></textarea>
          <small style="color:#666; font-size:11px;">
            –ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ photos/gallery/ –∏ —É–∫–∞–∂–∏—Ç–µ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 1-1.jpg, 1-2.jpg<br>
            –ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–µ URL —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
          </small>
        </div>

        <div class="form-buttons">
            <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" id="cancel-form-btn" style="background:#999;">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¢–∞–±–ª–∏—Ü—ã -->
  <div id="data-table-modal" class="modal">
    <div class="modal-content modal-large">
        <span class="close">&times;</span>
        <h2>–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <div style="overflow:auto; max-height:400px;">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>ID</th><th>–ò–º—è</th><th>–§–∞–º–∏–ª–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ò–º–ø–æ—Ä—Ç–∞ -->
  <div id="import-modal" class="modal">
      <div class="modal-content">
          <span class="close" id="cancel-import">&times;</span>
          <h2>–ò–º–ø–æ—Ä—Ç Excel</h2>
          <input type="file" id="excel-file" accept=".xlsx, .xls">
      </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –£–¥–∞–ª–µ–Ω–∏—è -->
  <div id="delete-modal" class="modal">
      <div class="modal-content">
          <span class="close" id="cancel-delete">&times;</span>
          <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
          <p id="delete-message">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
          <button id="confirm-delete" style="background:red; color:white;">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ü—Ä–æ—Ñ–∏–ª—è -->
  
  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="d3.v7.min.js"></script>
  <script src="xlsx.full.min.js"></script>
  <script src="FileSaver.min.js"></script>
  <!-- –£—Ç–∏–ª–∏—Ç—ã -->
  <script src="src/utils/dataStorage.js?v=202602121250"></script>
  <script src="src/core/DataManager.js?v=202602121250"></script>
  <!-- –Ø–¥—Ä–æ -->
  <script src="src/core/FamilyTree.js?v=202602121250"></script>
  <script src="src/core/TreeVisualizer.js?v=202602121250"></script>
  <!-- –£—Ç–∏–ª–∏—Ç—ã –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ -->
  <script src="src/utils/importExcel.js?v=202602121250"></script>
  <script src="src/utils/exportExcel.js?v=202602121250"></script>
  <!-- UI -->
  <script src="src/auth.js?v=202602121250"></script>
  <script src="src/utils/notifications.js?v=202602121250"></script>
  <script src="src/ui/forms.js?v=202602121250"></script>
  <script src="src/ui/table.js?v=202602121250"></script>
  <script src="src/ui/ProfileModal.js?v=202602121250"></script> 
  <script src="src/ui/modals.js?v=202602121250"></script>
  <script src="src/utils/GitHubSync.js?v=202602121250"></script>
  <script src="src/utils/github-integration.js?v=202602121250"></script>
  <!-- –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <script src="src/ui/app.js?v=202602121250"></script>

  <!-- ==================== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================== -->
  
  <script>
    /**
     * –§–£–ù–ö–¶–ò–Ø: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
     */
    window.reloadFromJSON = async function() {
      if (!window.dataManagerInstance) {
        alert('‚ùå DataManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
        return
      }
      
      if (!confirm('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ data/people.json? –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
        return
      }
      
      try {
        console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ JSON...')
        await window.dataManagerInstance.reload()
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        if (window.refreshAll) {
          window.refreshAll()
        } else {
          location.reload()
        }
        
        showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ JSON', 'success')
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', error)
        showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error')
      }
    }

    /**
     * –§–£–ù–ö–¶–ò–Ø: –ò–º–ø–æ—Ä—Ç JSON –∏–∑ —Ñ–∞–π–ª–∞
     */
    window.importJsonFile = function(event) {
      const file = event.target.files[0]
      if (!file) return
      
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result)
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç
          let people = []
          if (Array.isArray(data)) {
            people = data
          } else if (data.people && Array.isArray(data.people)) {
            people = data.people
          } else {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON')
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º
          localStorage.setItem('familyTreeData', JSON.stringify({ people: people }))
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
          location.reload()
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON:', error)
          alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message)
        }
      }
      reader.readAsText(file)
    }

    /**
     * –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON —Ñ–∞–π–ª
     */
    window.exportJsonFile = function() {
      try {
        const stored = localStorage.getItem('familyTreeData')
        if (!stored) {
          alert('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞')
          return
        }
        
        const data = JSON.parse(stored)
        const blob = new Blob([JSON.stringify(data, null, 2)], { 
          type: 'application/json' 
        })
        
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `family-tree-${new Date().toISOString().split('T')[0]}.json`
        a.click()
        URL.revokeObjectURL(url)
        
        showNotification('‚úÖ JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success')
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error)
        showNotification('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error')
      }
    }

    /**
     * –û–¢–õ–ê–î–ö–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
     */
    window.debugFamilyTree = function() {
      if (!window.dataManagerInstance) {
        console.log('‚ùå DataManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
        return
      }
      
      const debug = window.dataManagerInstance.getDebugInfo()
      
      console.log('%cüå≥ –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø', 'color: blue; font-size: 16px; font-weight: bold')
      console.table(debug)
      console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', debug.statistics)
      
      return debug
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    console.log('%cüå≥ –°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ v1.0.3', 'color: green; font-size: 16px; font-weight: bold')
    console.log('üìù –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: window.debugFamilyTree()')
  </script>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ GitHub —Ç–æ–∫–µ–Ω–∞ -->
  <div id="auth-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" onclick="document.getElementById('auth-modal').style.display='none'">&times;</span>
      <h2>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
      <p>–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω:</p>
      <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxx" style="width: 100%; padding: 10px; margin: 10px 0;">
      <div style="display: flex; gap: 10px;">
        <button onclick="window.verifyToken()" class="btn btn-primary">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button onclick="document.getElementById('auth-modal').style.display='none'" class="btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
      <p id="auth-status" style="margin-top: 10px;"></p>
    </div>
  </div>

  <script>
    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
    function clearCacheAndReload() {
      console.log('üóëÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –æ—á–∏—Å—Ç–∫—É –∫–µ—à–∞...');
      
      // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–µ—à–∏ –±—Ä–∞—É–∑–µ—Ä–∞
      if ('caches' in window) {
        caches.keys().then(keys => {
          console.log('–£–¥–∞–ª—è–µ–º –∫–µ—à–∏:', keys);
          return Promise.all(keys.map(key => caches.delete(key)));
        }).then(() => {
          console.log('‚úÖ –ö–µ—à–∏ —É–¥–∞–ª–µ–Ω—ã');
        });
      }
      
      // –û—á–∏—Å—Ç–∏—Ç—å localStorage
      console.log('–û—á–∏—â–∞–µ–º localStorage');
      localStorage.clear();
      
      // –û—á–∏—Å—Ç–∏—Ç—å sessionStorage
      console.log('–û—á–∏—â–∞–µ–º sessionStorage');
      sessionStorage.clear();
      
      console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
      
      // –ñ–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π URL —Å timestamp
      setTimeout(() => {
        window.location.href = window.location.pathname + '?nocache=' + Date.now();
      }, 500);
    }
  </script>
</body>
</html>
