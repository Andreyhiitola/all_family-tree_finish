class DataManager {
  constructor(storageKey = 'familyTreeData') {
    this.storageKey = storageKey
    this.versionKey = 'familyTreeVersion'
    this.currentVersion = '1.0.5'
    
    this.people = []
    this.isModified = false
    this.autoSaveTimer = null
    
    this.basePath = this.detectBasePath()
    this.dataPath = this.basePath + 'data/people.json'
    this.photosPath = this.basePath + 'photos'
  }

  detectBasePath() {
    const hostname = window.location.hostname
    const port = window.location.port
    
    if (hostname === 'localhost' || 
        hostname === '127.0.0.1' || 
        hostname === '0.0.0.0' ||
        hostname === '' ||
        port === '8760' ||
        window.location.protocol === 'file:') {
      console.log('ðŸ  Ð ÐµÐ¶Ð¸Ð¼: Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°')
      return './'
    }
    
    if (hostname.includes('github.io')) {
      const pathname = window.location.pathname
      const match = pathname.match(/^\/([^\/]+)/)
      const repoName = match ? match[1] : ''
      console.log('ðŸŒ Ð ÐµÐ¶Ð¸Ð¼: GitHub Pages, Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:', repoName)
      return repoName ? ('/' + repoName + '/') : '/'
    }
    
    console.log('ðŸŒ Ð ÐµÐ¶Ð¸Ð¼: Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÑÐµÑ€Ð²ÐµÑ€')
    return '/'
  }

  async init() {
    console.log('ðŸ“¥ DataManager: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...')
    console.log('ðŸ“‚ Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ:', this.basePath)
    console.log('ðŸ“‚ ÐŸÑƒÑ‚ÑŒ Ðº Ð´Ð°Ð½Ð½Ñ‹Ð¼:', this.dataPath)
    
    const cachedVersion = localStorage.getItem(this.versionKey)
    const isCacheValid = cachedVersion === this.currentVersion
    
    if (!isCacheValid && cachedVersion) {
      console.log('ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸:', cachedVersion, 'â†’', this.currentVersion)
      this.clearCache()
    }
    
    if (isCacheValid) {
      const cached = this.loadFromCache()
      if (cached && cached.length > 0) {
        this.people = cached
        this.normalizePeople()
        console.log('âœ… Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¸Ð· ÐºÐµÑˆÐ°:', this.people.length, 'Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº')
        return
      }
    }
    
    try {
      console.log('ðŸ“¡ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð· JSON Ñ„Ð°Ð¹Ð»Ð°:', this.dataPath)
      const data = await this.loadFromJSON()
      
      if (data && data.length > 0) {
        this.people = data
        this.normalizePeople()
        this.saveToCache()
        console.log('âœ… Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¸Ð· JSON:', this.people.length, 'Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº')
      } else {
        console.warn('âš ï¸ JSON Ñ„Ð°Ð¹Ð» Ð¿ÑƒÑÑ‚')
        this.people = []
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ JSON:', error)
      
      const stored = localStorage.getItem(this.storageKey)
      if (stored) {
        try {
          const parsed = JSON.parse(stored)
          this.people = Array.isArray(parsed) ? parsed : (parsed.people || [])
          this.normalizePeople()
          console.log('âš ï¸ Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¸Ð· ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ ÐºÐµÑˆÐ°:', this.people.length, 'Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº')
        } catch (e) {
          console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ ÐºÐµÑˆÐ°:', e)
          this.people = []
        }
      }
    }
  }

  async loadFromJSON() {
    const timestamp = new Date().getTime()
    const url = this.dataPath + '?t=' + timestamp
    
    console.log('ðŸŒ Ð—Ð°Ð¿Ñ€Ð¾Ñ:', url)
    
    const response = await fetch(url, {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    })
    
    console.log('ðŸ“Š HTTP ÑÑ‚Ð°Ñ‚ÑƒÑ:', response.status, response.statusText)
    
    if (!response.ok) {
      throw new Error('HTTP ' + response.status + ': ' + response.statusText)
    }
    
    const data = await response.json()
    
    if (Array.isArray(data)) {
      return data
    } else if (data.people && Array.isArray(data.people)) {
      return data.people
    } else {
      throw new Error('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ JSON')
    }
  }

  normalizePeople() {
    this.people = this.people.map(p => {
      const id = parseInt(p.id, 10) || 0
      const toId = (val) => {
        const n = parseInt(val, 10)
        return (isNaN(n) || n === 0) ? null : n
      }
      
      return {
        id: id,
        name: (p.name || '').trim(),
        surname: (p.surname || '').trim(),
        middlename: (p.middlename || '').trim(),
        gender: (p.gender === 'F' || p.gender === 'Ð–') ? 'F' : 'M',
        birthDate: p.birthDate || '',
        deathDate: p.deathDate || '',
        birthPlace: p.birthPlace || '',
        biography: p.biography || '',
        photo: p.photo || '',
        photos: Array.isArray(p.photos) ? p.photos : [],
        fatherId: toId(p.fatherId),
        motherId: toId(p.motherId),
        spouseId: toId(p.spouseId)
      }
    }).filter(p => p.id !== 0)
    
    console.log('âœ… ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾:', this.people.length, 'Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº')
  }

  loadFromCache() {
    try {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ ÐºÐµÑˆÐ°
      const cachedVersion = localStorage.getItem(this.versionKey)
      if (cachedVersion !== this.currentVersion) {
        console.log("ðŸ”„ Ð’ÐµÑ€ÑÐ¸Ñ ÐºÐµÑˆÐ° ÑƒÑÑ‚Ð°Ñ€ÐµÐ»Ð°:", cachedVersion, "â†’", this.currentVersion, "- Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐµÑˆ")
        this.clearCache()
        return null
      }
      
      const json = localStorage.getItem(this.storageKey)
      if (!json) return null
      
      const parsed = JSON.parse(json)
      const data = Array.isArray(parsed) ? parsed : (parsed.people || [])
      
      return data.length > 0 ? data : null
    } catch (e) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ ÐºÐµÑˆÐ°:", e)
      return null
    }
  }

  saveToCache() {
    try {
      localStorage.setItem(this.storageKey, JSON.stringify({ people: this.people }))
      localStorage.setItem(this.versionKey, this.currentVersion)
      console.log('ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð² ÐºÐµÑˆ')
    } catch (e) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² ÐºÐµÑˆ:', e)
    }
  }

  clearCache() {
    localStorage.removeItem(this.storageKey)
    localStorage.removeItem(this.versionKey)
    console.log('ðŸ—‘ï¸ ÐšÐµÑˆ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½')
  }

  async reload() {
    console.log('ðŸ”„ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...')
    this.clearCache()
    this.people = []
    await this.init()
    return this.people
  }

  getPhotoUrl(photoPath) {
    if (!photoPath) {
      return this.photosPath + '/default-avatar.png'
    }
    
    if (photoPath.startsWith('http://') || photoPath.startsWith('https://')) {
      return photoPath
    }
    
    if (photoPath.startsWith('/')) {
      return photoPath
    }
    
    if (photoPath.startsWith('photos/') || photoPath.startsWith('avatars/')) {
      return photoPath
    }
    
    return this.photosPath + '/avatars/' + photoPath
  }

  getGalleryUrls(photos) {
    if (!Array.isArray(photos)) return []
    
    const self = this
    return photos.map(function(photo) {
      if (!photo) return null
      
      if (photo.startsWith('http://') || photo.startsWith('https://')) {
        return photo
      }
      
      if (photo.startsWith('/')) {
        return photo
      }
      
      return self.photosPath + '/gallery/' + photo
    }).filter(function(url) {
      return url !== null
    })
  }

  generateId() { 
    if (this.people.length === 0) return 1
    return this.people.reduce(function(max, p) {
      return Math.max(max, p.id || 0)
    }, 0) + 1
  }

  getPeople() { 
    return this.people 
  }
  
  setPeople(people) { 
    this.people = people || []
    this.normalizePeople()
    this.isModified = true
    this.save()
  }

  upsertPerson(person) {
    if (!person.id) person.id = this.generateId()
    const idx = this.people.findIndex(function(p) {
      return p.id === person.id
    })
    if (idx === -1) {
      this.people.push(person)
    } else {
      this.people[idx] = person
    }
    this.isModified = true
    this.normalizePeople()
    this.save()
  }

  deletePerson(id) {
    this.people = this.people.filter(function(p) {
      return p.id !== id
    })
    this.isModified = true
    this.save()
  }

  save() {
    this.saveToCache()
    this.isModified = false
  }

  startAutoSave(intervalMs, callback) {
    const self = this
    if (this.autoSaveTimer) clearInterval(this.autoSaveTimer)
    
    this.autoSaveTimer = setInterval(function() {
      if (self.isModified) {
        self.save()
        if (callback) callback()
      }
    }, intervalMs)
    
    console.log('â° ÐÐ²Ñ‚Ð¾ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾:', intervalMs, 'Ð¼Ñ')
  }

  clearAll() {
    this.people = []
    this.save()
  }

  getStatistics() {
    return {
      total: this.people.length,
      males: this.people.filter(function(p) { return p.gender === 'M' }).length,
      females: this.people.filter(function(p) { return p.gender === 'F' }).length,
      withPhotos: this.people.filter(function(p) { return p.photo }).length,
      withGallery: this.people.filter(function(p) { return p.photos && p.photos.length > 0 }).length,
      living: this.people.filter(function(p) { return !p.deathDate }).length,
      deceased: this.people.filter(function(p) { return p.deathDate }).length
    }
  }

  getDebugInfo() {
    return {
      version: this.currentVersion,
      hostname: window.location.hostname,
      port: window.location.port,
      protocol: window.location.protocol,
      basePath: this.basePath,
      dataPath: this.dataPath,
      photosPath: this.photosPath,
      peopleCount: this.people.length,
      cacheVersion: localStorage.getItem(this.versionKey),
      statistics: this.getStatistics()
    }
  }
}

window.DataManager = DataManager
